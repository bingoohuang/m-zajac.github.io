<html>
	<head>
        <meta charset="utf-8">
        
        <title>json2go web parser</title>
        <link rel="stylesheet" href="https://unpkg.com/chota@latest">
	</head>
	<body>
        <div class="container">
            <h1>json2go web parser</h1>

            <div class="row">
                <p>
                    For source code see <a href="https://github.com/m-zajac/json2go">https://github.com/m-zajac/json2go</a>
                </p>
            </div>

            <div class="row">
                <textarea id="input" class="json2go" cols="30" rows="10" placeholder="Paste json here"></textarea>
            </div>
        
            <div class="row">
                <label class="col-3 row card is-center">
                    <input id="rootName" class="json2go" type="text" placeholder="Root name" />
                </label>
                <label class="col-3 card is-center">
                    <input id="extractCommonTypes" class="json2go" type="checkbox" checked="true" />
                    Extract common types
                </label>
                <label class="col-6 card is-text-center">
                    <input id="stringPointersWhenKeyMissing" class="json2go" type="checkbox" checked="true" />
                    String pointers when key is missing
                </label>
            </div>
            <div class="row">
                <pre id="output" class="is-full-width"></pre>
            </div>
        </div>

        <script src="wasm_exec.js"></script>
        <script>
            if (!WebAssembly.instantiateStreaming) { // polyfill
                WebAssembly.instantiateStreaming = async (resp, importObject) => {
                    const source = await (await resp).arrayBuffer();
                    return await WebAssembly.instantiate(source, importObject);
                };
            }
    
            const go = new Go();
            let mod, inst;
            WebAssembly.instantiateStreaming(fetch("json2go.wasm"), go.importObject).then((result) => {
                mod = result.module;
                inst = result.instance;
                go.run(inst);
            }).then(() => {
                let waitMsg = "waiting for valid json ...";
                let outEl = document.getElementById("output");

                let onChange = () => {
                    let json = document.getElementById("input").value;
                    let rootName = document.getElementById("rootName").value || "Document";

                    let opts = {
                        extractCommonTypes: document.getElementById("extractCommonTypes").checked,
                        stringPointersWhenKeyMissing: document.getElementById("stringPointersWhenKeyMissing").checked,
                        rootName: rootName,
                    };
                    let out = json2go(json, opts);

                    if (out) {
                        outEl.innerHTML = out;
                    } else {
                        outEl.innerHTML = waitMsg;
                    }
                }
                for (let el of document.getElementsByClassName("json2go")) {
                    el.addEventListener("input", onChange);
                    el.addEventListener("change", onChange);
                }
                onChange();
            }).catch((err) => {
                console.error(err);
            });
        </script>
    </body>
</html>